<!DOCTYPE html>
<html>
<head>
    <title>Crave</title>
    <link rel="stylesheet"
     href="stylesheets/apple.css"
     type="text/css" />
    <link rel="stylesheet"
     href="stylesheets/custom.css"
     type="text/css" />

</head>

<body>

<img src="images/crave-startup.png" border="0" class="startuppic"/>

<script type="text/javascript" src="sencha-touch.js"></script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="dishes.js"></script>
<script type="text/javascript" src="restaurants.js"></script>
<script type="text/javascript" src="search.js"></script>
<script type="text/javascript" src="navigation.js"></script>

<script type="text/javascript">
    Ext.setup({
       glossOnIcon: false,
       onReady: function() {

           urlPrefix = "";
           urlPrefixSet=false;
           if(window.location.toString().indexOf("http://localhost")>-1) {
               urlPrefixSet=true;
               urlPrefix = '/wg/proxy.php?url=http://blooming-water-228.heroku.com';
           }

           navigator.geolocation.getCurrentPosition(function(position) {
               console.log('location got');
               console.log('/restaurants.json?lat='+position.coords.latitude+'&long='+position.coords.longitude);
               if(urlPrefixSet) {
                   dishStore.proxy.url = urlPrefix+encodeURIComponent('/menu_items/location.json?lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude);
                   restaurants.proxy.url = urlPrefix+encodeURIComponent('/restaurants.json?lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude);
               } else {
                   dishStore.proxy.url = '/menu_items/location.json?lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude;
                   restaurants.proxy.url = '/restaurants.json?lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude;
               }
               
               dishStore.load();
               restaurants.load();
           });


           var placesList = new Ext.List({
               onItemDisclosure: {
                   handler: function(record, btn, index) {
                       singleRestaurantStore.proxy.url = (urlPrefix+'/restaurants/'+record.data.id+'/menu_items.json');

                       singleRestaurantStore.load(function(){
                           Ext.getCmp('mainPnl').setActiveItem(2);
                       });

                       Ext.Ajax.request({
                           url: (urlPrefix+'/restaurants/'+record.data.id+'.json'),
                           reader: {
                                type: 'json'
                           },
                           success: function(response) {
                                //populate top panel with restaurant data, map
                                var responseObject = eval('(' + response.responseText + ')');
                               console.log(responseObject);
                                htmlString = '<div class="restaurantInfo">'+responseObject.restaurant.name+'</div>';
                                Ext.getCmp('restInfoPnl').update(htmlString);

                               var placeholder = new google.maps.Marker(
                                   {
                                       position: new google.maps.LatLng(responseObject.restaurant.latitude,responseObject.restaurant.longitude),
                                       map: Ext.getCmp('googleMap').map,
                                       title: 'restaurant'
                                   }
                               );
                               var initialLocation = new google.maps.LatLng(responseObject.restaurant.latitude,responseObject.restaurant.longitude);
                               Ext.getCmp('googleMap').update(initialLocation)
                               // woah baby, this is a nasty hack but the map refuses to behave unless you trigger resize after a delay AFTER the initial ajax returns
                               Ext.Ajax.request({
                                   url: (urlPrefix+'/restaurants/'+record.data.id+'.json'),
                                   reader: {
                                        type: 'json'
                                   },
                                   success: function(response) {
                                       google.maps.event.trigger(Ext.getCmp('googleMap').map, 'resize');
                                   }
                               });
                           }
                       });
                   }
               },
               itemTpl: dishTemplate,
               singleSelect: true,
               grouped: false,
               indexBar: false,
               store: restaurants,

               floating:true,
               centered:true,
               modal:true,
               hideOnMaskTap: false,
               clearSectionOnDeactivate:true
           });

           var dishList = new Ext.List({
               onItemDisclosure: {
                   handler: function(record, btn, index) {
                       console.log(record.data.id);
                       /*
                        if(Ext.getCmp('carouselPnl')) {
                            Ext.getCmp('carouselPnl').destroy();
                        }
                       var carouselPnl = new Ext.Carousel({
                           id: 'carouselPnl',
                           direction: 'horizontal',
                           items: [
                           ],
                           width:'100%',
                           height:'150px'
                       });
                       */
                       Ext.Ajax.request({
                           url: (urlPrefix+'/menu_items/'+record.data.id+'.json'),
                           reader: {
                                type: 'json'
                           },
                           success: function(response) {
                               var responseObject = eval('(' + response.responseText + ')');
                               htmlString = '<div class="dishinfo"><b>'+responseObject.menu_item.name+'</b><br/>';
                               htmlString += '$ '+responseObject.menu_item.price+'<br>';
                               htmlString += '<br><br>'+responseObject.menu_item.description+'<br>';
                               /*for(i=0;i<responseObject[0].ingredients.length;i++) {
                                htmlString += responseObject[0].ingredients[i].item;
                                   if(i<responseObject[0].ingredients.length - 1) {
                                       htmlString += ", ";
                                   }
                               }*/
                               htmlString += "</div>";
                               /*
                               for(i=0;i<responseObject[0].images.length;i++) {
                                   object = new Object();
                                   object.html = '<div class="foodImg"><img width="100" src="'+responseObject[0].images[i].file+'"></div>';
                                   object.xtype = 'panel';
                                   Ext.getCmp('carouselPnl').add(object);
                               }
                               reviewString = "<br><br><b>Reviews</b><br><br>";
                               for(i=0;i<responseObject[0].reviews.length;i++) {
                                   if(responseObject[0].reviews[i].pic==""){
                                       pic = "nothing.jpg";
                                   } else {
                                       pic = responseObject[0].reviews[i].pic;
                                   }
                                   reviewString += '<div class="picanddata"><img class="pic" src="'+pic+'" width="70"><div class="data">'+responseObject[0].reviews[i].reviewer+'<br>'+responseObject[0].reviews[i].rating+' stars</div><br><div class="reviewtext">'+responseObject[0].reviews[i].text+'</div></div>';
                               }
                               */
                               //Ext.getCmp('detailPnl').add(carouselPnl);
                               Ext.getCmp('detailPnl').add(infoPnl);
                               //Ext.getCmp('detailPnl').add(reviewPnl);
                               Ext.getCmp('infoPnl').update(htmlString);
                               //Ext.getCmp('reviewPnl').update(reviewString);
                           }
                       });
                       Ext.getCmp('mainPnl').setActiveItem(1);
                       //Ext.getCmp('detailPnl').setLoading(false);

                   }
               },
               itemTpl: dishTemplate,
               //itemSelector: 'div.adish',
               //this breaks my onItemDisclosure activity
               singleSelect: true,
               grouped: false,
               indexBar: false,
               store: dishStore,
               id:'dishesNearbyList',
               scroll:'vertical',

               floating:true,
               width:350,
               height:370,
               centered:true,
               modal:true,
               hideOnMaskTap: false,
               clearSectionOnDeactivate:true
           });


           var onScroll = new function(something) {
               console.log('scrolling');
           }

           var infoPnl = new Ext.Panel({
               html: '',
               id: 'infoPnl'
           });

           //add pin to map at address
           var restMapPnl = new Ext.Panel ({
               //need to pass in coords
               items: [
                   {
                   id: 'googleMap',
                   xtype: 'map',
                   useCurrentLocation: false,
                   mapOptions : {
                       center : new google.maps.LatLng(37.774518,-122.420101),  //SF
                       //not really centering here, just putting it in top right corner
                       zoom : 17,
                       mapTypeId : google.maps.MapTypeId.ROADMAP,
                       disableDefaultUI: true,
                       navigationControl: false
                     }
                   }
               ],
               height:'100px',
               flex:1
           });
           var restInfoPnl = new Ext.Panel({
               html: '',
               id: 'restInfoPnl',
               flex:2,
               height:'100%'
           });
           var restPnl = new Ext.Panel({
               id: 'restPnl',
               layout: 'hbox',
               items:[restMapPnl,restInfoPnl],
               width:'100%',
               height:100

           });

           var reviewPnl = new Ext.Panel({
               html: '',
               scroll: 'vertical',
               id: 'reviewPnl'
           });

           var tapHandler = function(b,e) {
               if(b.getText() == "Dishes") {
                   Ext.getCmp('listPnl').setActiveItem(dishList);
               }
               if(b.getText() == "Restaurants") {
                   Ext.getCmp('listPnl').setActiveItem(placesList);
               }
           }

       var detailPnl = new Ext.Panel({
           fullScreen: true,
           items: [infoPnl,reviewPnl],
           id: 'detailPnl',
           layout: {
               type: 'vbox',
               align: 'start',
               direction: 'normal'
           },
           dockedItems:[
               {
                   dock:'top',
                   xtype:'toolbar',
                   ui:'light',
                   title:'Crave',
                   items:[{text:'Back',ui:'back', handler:backHandler}]
               }
           ]
       });

       var listPnl = new Ext.Panel({
           id: 'listPnl',
           items: [dishList,placesList,searchPnl],
           layout: {
               type: 'card'
           },
           cardSwitchAnimation: 'slide',
           direction:'horizontal',
           dockedItems: [
               {
                   id: 'topPanel',
                   xtype: 'toolbar',
                   ui:'light',
                   dock: 'top',
                   layout:{pack:'center'},
                   items:[
                       {xtype:'segmentedbutton',
                       items:[
                           {text:'Dishes',pressed:true, handler:tapHandler},
                           {text:'Restaurants', handler:tapHandler}
                       ]}
                   ]
               },searchForm
               /*,
               {
                   id:'bottomPanel',
                   xtype: 'toolbar',
                   dock:'bottom',
                   ui:'dark',
                   items:[
                       {xtype:'segmentedbutton',
                       items:[
                           {text:'Nearby',pressed:true}
                       ]}
                    ]
               }
                       */
           ]
       });

           var restaurantPnl = new Ext.Panel({
               id: 'restaurantPnl',
               items: [restPnl,aRestaurantList],
               fullscreen:true,
               layout: {
                   type: 'vbox',
                   align: 'start',
                   direction: 'normal'
               },
               dockedItems:[
                   {
                       dock:'top',
                       xtype:'toolbar',
                       ui:'light',
                       title:'Crave',
                       items:[{text:'Back',ui:'back', handler:backHandler}]
                   }
               ]
           });

           var mainPnl = new Ext.Panel({
               fullscreen: true,
               id: 'mainPnl',
               items: [listPnl,detailPnl,restaurantPnl],
               layout: {
                   type: 'card'
               },
               cardSwitchAnimation: 'slide',
               direction:'horizontal'
           });

   }

});
</script>

</body>
</html>