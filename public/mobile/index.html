<!DOCTYPE html>
<html>
<head>
    <title>crave</title>
    <link rel="stylesheet"
     href="stylesheets/apple.css"
     type="text/css" />
    <link rel="stylesheet"
     href="stylesheets/custom.css"
     type="text/css" />

</head>

<body>

<img src="../images/loading-screen.png" border="0" class="startuppic"/>

<script type="text/javascript" src="sencha-touch.js"></script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script type="text/javascript" src="session.js"></script>
<script type="text/javascript" src="navigation.js"></script>
<script type="text/javascript" src="dishes.js"></script>
<script type="text/javascript" src="restaurants.js"></script>
<script type="text/javascript" src="search.js"></script>

<script type="text/javascript">
    Ext.setup({
       glossOnIcon: false,
       onReady: function() {

           urlPrefix = "";
           urlPrefixSet=false;
           if(window.location.toString().indexOf("http://localhost")>-1) {
               urlPrefixSet=true;
               urlPrefix = '/wg/proxy.php?url=http://blooming-water-228.heroku.com';
           }

           navigator.geolocation.getCurrentPosition(function(position) {
               if(urlPrefixSet) {
                   console.log('setting proxy url');
                   dishStore.proxy.url = urlPrefix+encodeURIComponent('/items/location.json?sort=distance&lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude);
                   //dishStore.proxy.url = urlPrefix+encodeURIComponent('/items/location.json?lat=37.77867&limit=25&long=-122.39127');
                   places.proxy.url = urlPrefix+encodeURIComponent('/places.json?sort=distance&lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude);
               } else {
                   dishStore.proxy.url = encodeURIComponent('/items/location.json?sort=distance&lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude);
                   places.proxy.url = '/places.json?sort=distance&lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude;
               }
               console.log(dishStore.proxy.url);
               dishStore.load(function() {
                   console.log('dish store loaded');
                   console.log(dishStore);
               });
               places.load();
           });


           var placesList = new Ext.List({
               itemTpl: restaurantTemplate,
               singleSelect: true,
               grouped: false,
               indexBar: false,
               store: places,

               floating:true,
               centered:true,
               modal:true,
               hideOnMaskTap: false,
               clearSectionOnDeactivate:true
           });
           placesList.on('itemtap', function(dataView, index, item, e) {
               record = dataView.store.data.items[index];
               placeDisplay(record, index);
           });

           var dishList = new Ext.List({
               itemTpl: dishTemplate,
               itemSelector: '.adish',
               singleSelect: true,
               grouped: true,
               indexBar: false,
               store: dishStore,
               id:'dishesNearbyList',
               scroll:'vertical',

               width:350,
               height:370,
               hideOnMaskTap: false,
               clearSectionOnDeactivate:true
           });

           dishList.on('itemtap', function(dataView, index, item, e) {
               record = dataView.store.data.items[index];
               /*
                if(Ext.getCmp('carouselPnl')) {
                    Ext.getCmp('carouselPnl').destroy();
                }
               var carouselPnl = new Ext.Carousel({
                   id: 'carouselPnl',
                   direction: 'horizontal',
                   items: [
                   ],
                   width:'100%',
                   height:'150px'
               });
               */
               Ext.Ajax.request({
                   url: (urlPrefix+'/items/'+record.data.id+'.json'),
                   reader: {
                        type: 'json'
                   },
                   success: function(response) {
                       dishDisplay(response);
                   }
               });
               Ext.getCmp('mainPnl').setActiveItem(1);
               //Ext.getCmp('detailPnl').setLoading(false);

           });

           var infoPnl = new Ext.Panel({
               html: '',
               id: 'infoPnl'
           });

           var restMapPnl = new Ext.Panel ({
               items: [
                   {
                   id: 'googleMap',
                   xtype: 'map',
                   useCurrentLocation: false,
                   height:100,
                   width:100,
                   mapOptions : {
                       center : new google.maps.LatLng(37.774518,-122.420101),  //SF
                       //not really centering here, just putting it in top right corner
                       zoom : 17,
                       mapTypeId : google.maps.MapTypeId.ROADMAP,
                       disableDefaultUI: true,
                       navigationControl: false
                     }
                   }
               ],
               height:100,
               width:100
           });
           var restInfoPnl = new Ext.Panel({
               html: '',
               id: 'restInfoPnl',
               height:'100%',
               width:'100%'
           });
           var restPnl = new Ext.Panel({
               id: 'restPnl',
               layout: 'hbox',
               items:[restMapPnl,restInfoPnl],
               width:'100%',
               height:100

           });

           var reviewPnl = new Ext.Panel({
               html: '',
               scroll: 'vertical',
               id: 'reviewPnl'
           });

           var sessionHandler = function(b,e) {
               if(b.getText() == "Login") {
                   window.location = 'http://getcrave.com/auth/facebook';
               }
               if(b.getText() == "Logout") {
                   localStorage.setItem("uid","");
                   Ext.getCmp("loginButton").setVisible(true);
                   Ext.getCmp("logoutButton").setVisible(false);
               }
               if(b.getText() == "New Restaurant") {
                   Ext.getCmp('listPnl').setActiveItem(newRestaurant);
               }
           }

           var tapHandler = function(b,e) {
               if(b.getText() == "Items") {
                   Ext.getCmp('listPnl').setActiveItem(dishList);
                   Ext.getCmp("newRestButton").setVisible(false);
               }
               if(b.getText() == "Places") {
                   Ext.getCmp('listPnl').setActiveItem(placesList);
                   Ext.getCmp("newRestButton").setVisible(true);
               }
           }

       var detailPnl = new Ext.Panel({
           fullScreen: true,
           items: [infoPnl,reviewPnl],
           id: 'detailPnl',
           layout: {
               type: 'vbox',
               align: 'start',
               direction: 'normal'
           },
           scroll:'vertical',
           dockedItems:[
               {
                   dock:'top',
                   xtype:'toolbar',
                   ui:'light',
                   title:'<img class="cravelogo" src="../images/crave-logo-horizontal-white.png">',
                   items:[{text:'Back',ui:'back', handler:backHandler}]
               }
           ]
       });

       //intentionally not using var to make this global
       listPnl = new Ext.Panel({
           id: 'listPnl',
           items: [dishList,placesList,searchPnl,newRestaurant],
           layout: {
               type: 'card'
           },
           cardSwitchAnimation: 'slide',
           direction:'horizontal',
           dockedItems: [
               {
                   id: 'topPanel',
                   xtype: 'toolbar',
                   ui:'light',
                   dock: 'top',
                   layout:{pack:'center'},
                   items:[
                       {xtype:'segmentedbutton',
                       items:[
                           {text:'Items',id:'dishesButton',pressed:true, handler:tapHandler,ui:'round',width:'110'}, //,icon:'../images/dish-icon-ON.png',iconAlign:'left'
                           {text:'Places',id:'placesButton', pressed:false, handler:tapHandler,ui:'round',width:'110'} //,icon:'../images/restaurant-icon-OFF.png',iconAlign:'left'
                       ]}
                   ]
               },searchForm,
               {
                   id:'bottomPanel',
                   xtype: 'toolbar',
                   dock:'bottom',
                   ui:'dark',
                   items:[
                       {xtype:'segmentedbutton',
                       layout:{pack:'center'},
                       items:[
                           {text:'Login',id:'loginButton',handler:sessionHandler},
                           {text:'Logout',id:'logoutButton',handler:sessionHandler,hidden:true},
                           {text:'New Restaurant',id:'newRestButton',handler:sessionHandler,hidden:true}
                       ]}
                    ]
               }
           ]
       });

           var placePnl = new Ext.Panel({
               id: 'placePnl',
               items: [restPnl,aRestaurantList],
               fullscreen:true,
               layout: {
                   type: 'vbox',
                   align: 'start',
                   direction: 'normal'
               },
               dockedItems:[
                   {
                       dock:'top',
                       xtype:'toolbar',
                       ui:'light',
                       title:'<img class="cravelogo" src="../images/crave-logo-horizontal-white.png">',
                       items:[{text:'Back',ui:'back', handler:backHandler}]
                   }
               ]
           });

           var mainPnl = new Ext.Panel({
               fullscreen: true,
               id: 'mainPnl',
               items: [listPnl,detailPnl,placePnl,newDishForm],
               layout: {
                   type: 'card'
               },
               cardSwitchAnimation: 'slide',
               direction:'horizontal'
           });

           justLoggedIn();
   }

});

$(".newDish").live("click",function() {
    //activate new dish form
    Ext.getCmp('mainPnl').setActiveItem(3);
    return false;
});
</script>
</body>
</html>