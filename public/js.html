<!DOCTYPE html>
<html>
<head>
    <title>Crave</title>
    <link rel="stylesheet"
     href="stylesheets/apple.css"
     type="text/css" />
    <link rel="stylesheet"
     href="stylesheets/custom.css"
     type="text/css" />

</head>

<body>

<img src="images/crave-startup.png" border="0" class="startuppic"/>

<script type="text/javascript"
     src="javascripts/sencha-touch.js"></script>
<script type="text/javascript"
     src="javascripts/jquery.js"></script>

<script type="text/javascript">
    Ext.setup({
       glossOnIcon: false,
       onReady: function() {

           urlPrefix = "";
           urlPrefixSet=false;
           if(window.location.toString().indexOf("http://localhost")>-1) {
               urlPrefixSet=true;
               urlPrefix = '/wg/proxy.php?url=http://blooming-water-228.heroku.com';
           }
           console.log(urlPrefix);

           dishTemplate = new Ext.XTemplate('<tpl for="."><div class="adish"><b>{name}</b><br/>{[this.distDisplay(parent.distance)]}</div></tpl>',
               {distDisplay: function(miles) {
                   feet = Math.round(miles * 5280);
                   if(feet<1000) {
                       return feet+" feet";
                   } else {
                       return miles.toFixed(1)+' miles';
                   }
               }});

           Ext.regModel('Dish',
           {
               fields: ['city','distance','name','id', 'restaurant_id']
           });

           Ext.regModel('RestaurantDish',
           {
               fields: ['name','id','price','description','restaurant_id']
           });

           Ext.regModel('Restaurants',
           {
               fields: ['distance','name','id']
           });

           var restaurants = new Ext.data.Store({
              model: 'Restaurants',
               id: 'restaurants',

              proxy: {
                  type:'ajax',
                  url:'',
                  reader: {
                      type:'json',
                      record:'restaurant'
                  }
              }
          });

           var singleRestaurantStore = new Ext.data.Store({
               model: 'Dish',
               proxy: {
                   type:'ajax',
                   url:'',
                  reader: {
                      type:'json',
                      record:'menu_item'
                  }
               }
          });

           var store = new Ext.data.Store({
               model: 'Dish',
               proxy: {
                   type:'ajax',
                   url:'',
                  reader: {
                      type:'json',
                      record:'restaurant'
                  }
               }
           });
           navigator.geolocation.getCurrentPosition(function(position) {
               console.log('location got');
               //console.log(restaurants);
               console.log('/restaurants.json?lat='+position.coords.latitude+'&long='+position.coords.longitude);
               if(urlPrefixSet) {
                   store.proxy.url = urlPrefix+encodeURIComponent('/menu_items/location.json?lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude);
                   restaurants.proxy.url = urlPrefix+encodeURIComponent('/restaurants.json?lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude);
               } else {
                   store.proxy.url = '/menu_items/location.json?lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude;
                   restaurants.proxy.url = '/restaurants.json?lat='+position.coords.latitude+'&limit=25&long='+position.coords.longitude;
               }
               store.load();
               Ext.getCmp("dishesNearbyList").scroller.on('scroll', this.onScroll, this);
               restaurants.load();
           });
           var aRestaurantList = new Ext.List({
               id:'aRestaurantList',
               onItemDisclosure: {
                   handler: function(record, btn, index) {
                       Ext.Ajax.request({
                           url: (urlPrefix+'/menu_items/'+record.data.id+'.json'),
                           reader: {
                                type: 'json'
                           },
                           success: function(response) {
                               var responseObject = eval('(' + response.responseText + ')');
                               htmlString = '<div class="dishinfo"><b>'+responseObject.menu_item.name+'</b><br/>';
                               htmlString += '$ '+responseObject.menu_item.price+'<br>';
                               htmlString += '<br><br>'+responseObject.menu_item.description+'<br>';
                               htmlString += "</div>";
                               Ext.getCmp('infoPnl').update(htmlString);
                           }
                       });
                       Ext.getCmp('mainPnl').setActiveItem(1);
                   }
               },
               itemTpl: '<tpl for="."><div class="thisdish"><b>{name}</b></div></tpl>',
               singleSelect: true,
               grouped: false,
               indexBar: false,
               layout:{type:'vbox'},
               fullscreen:false,
               store: singleRestaurantStore,

               width:'100%',
               height:'100%',
               modal:true,
               hideOnMaskTap: false
           });

           var placesList = new Ext.List({
               onItemDisclosure: {
                   handler: function(record, btn, index) {
                       singleRestaurantStore.proxy.url = (urlPrefix+'/restaurants/'+record.data.id+'/menu_items.json');
                       singleRestaurantStore.load(function(){
                           Ext.getCmp('mainPnl').setActiveItem(2);
                           //$("#aRestaurantList").removeClass("x-hidden-display");
                       });

                       Ext.Ajax.request({
                           url: (urlPrefix+'/restaurants/'+record.data.id+'.json'),
                           reader: {
                                type: 'json'
                           },
                           success: function(response) {
                                //populate top panel with restaurant data, map
                                var responseObject = eval('(' + response.responseText + ')');
                                htmlString = '<div class="restaurantInfo">'+responseObject.restaurant.name+'</div>';
                                Ext.getCmp('restPnl').update(htmlString);
                           }
                       });
                   }
               },
               itemTpl: dishTemplate,
               singleSelect: true,
               grouped: false,
               indexBar: false,
               store: restaurants,

               floating:true,
               centered:true,
               modal:true,
               hideOnMaskTap: false,
               clearSectionOnDeactivate:true
           });

           var list = new Ext.List({
               onItemDisclosure: {
                   handler: function(record, btn, index) {
                       console.log(record.data.id);
                       /*
                        if(Ext.getCmp('carouselPnl')) {
                            Ext.getCmp('carouselPnl').destroy();
                        }
                       var carouselPnl = new Ext.Carousel({
                           id: 'carouselPnl',
                           direction: 'horizontal',
                           items: [
                           ],
                           width:'100%',
                           height:'150px'
                       });
                       */
                       Ext.Ajax.request({
                           url: (urlPrefix+'/menu_items/'+record.data.id+'.json'),
                           reader: {
                                type: 'json'
                           },
                           success: function(response) {
                               var responseObject = eval('(' + response.responseText + ')');
                               htmlString = '<div class="dishinfo"><b>'+responseObject.menu_item.name+'</b><br/>';
                               htmlString += '$ '+responseObject.menu_item.price+'<br>';
                               htmlString += '<br><br>'+responseObject.menu_item.description+'<br>';
                               /*for(i=0;i<responseObject[0].ingredients.length;i++) {
                                htmlString += responseObject[0].ingredients[i].item;
                                   if(i<responseObject[0].ingredients.length - 1) {
                                       htmlString += ", ";
                                   }
                               }*/
                               htmlString += "</div>";
                               /*
                               for(i=0;i<responseObject[0].images.length;i++) {
                                   object = new Object();
                                   object.html = '<div class="foodImg"><img width="100" src="'+responseObject[0].images[i].file+'"></div>';
                                   object.xtype = 'panel';
                                   Ext.getCmp('carouselPnl').add(object);
                               }
                               reviewString = "<br><br><b>Reviews</b><br><br>";
                               for(i=0;i<responseObject[0].reviews.length;i++) {
                                   if(responseObject[0].reviews[i].pic==""){
                                       pic = "nothing.jpg";
                                   } else {
                                       pic = responseObject[0].reviews[i].pic;
                                   }
                                   reviewString += '<div class="picanddata"><img class="pic" src="'+pic+'" width="70"><div class="data">'+responseObject[0].reviews[i].reviewer+'<br>'+responseObject[0].reviews[i].rating+' stars</div><br><div class="reviewtext">'+responseObject[0].reviews[i].text+'</div></div>';
                               }
                               */
                               //Ext.getCmp('detailPnl').add(carouselPnl);
                               Ext.getCmp('detailPnl').add(infoPnl);
                               //Ext.getCmp('detailPnl').add(reviewPnl);
                               Ext.getCmp('infoPnl').update(htmlString);
                               //Ext.getCmp('reviewPnl').update(reviewString);
                           }
                       });
                       Ext.getCmp('mainPnl').setActiveItem(1);
                       //Ext.getCmp('detailPnl').setLoading(false);

                   }
               },
               itemTpl: dishTemplate,
               //itemSelector: 'div.adish',
               //this breaks my onItemDisclosure activity
               singleSelect: true,
               grouped: false,
               indexBar: false,
               store: store,
               id:'dishesNearbyList',
               scroll:'vertical',

               floating:true,
               width:350,
               height:370,
               centered:true,
               modal:true,
               hideOnMaskTap: false,
               clearSectionOnDeactivate:true
           });


           var onScroll = new function(something) {
               console.log('scrolling');
           }

           //Ext.getCmp("dishesNearbyList").scroller.on('scroll', this.onScroll, this);

           var infoPnl = new Ext.Panel({
               html: '',
               id: 'infoPnl'
           });
           var restPnl = new Ext.Panel({
               html: '',
               id: 'restPnl',
               width:'100%',
               height:100,
               ExtraCls: 'dashedBorder'

           });
           var reviewPnl = new Ext.Panel({
               html: '',
               scroll: 'vertical',
               id: 'reviewPnl'
           });

           var backHandler = function(b,e) {
               if(b.getText() == "Back") {
                   Ext.getCmp('mainPnl').setActiveItem(0);
               }
           }

           var tapHandler = function(b,e) {
               if(b.getText() == "Dishes") {
                   Ext.getCmp('listPnl').setActiveItem(0);
               }
               if(b.getText() == "Restaurants") {
                   Ext.getCmp('listPnl').setActiveItem(1);
               }
           }

       var detailPnl = new Ext.Panel({
           fullScreen: true,
           items: [infoPnl,reviewPnl],
           id: 'detailPnl',
           layout: {
               type: 'vbox',
               align: 'start',
               direction: 'normal'
           },
           dockedItems:[
               {
                   dock:'top',
                   xtype:'toolbar',
                   ui:'light',
                   title:'Crave',
                   items:[{text:'Back',ui:'back', handler:backHandler}]
               }
           ]
       });

       var listPnl = new Ext.Panel({
           id: 'listPnl',
           items: [list,placesList],
           layout: {
               type: 'card'
           },
           cardSwitchAnimation: 'slide',
           direction:'horizontal',
           dockedItems: [
               {
                   id: 'topPanel',
                   xtype: 'toolbar',
                   ui:'light',
                   dock: 'top',
                   layout:{pack:'center'},
                   items:[
                       {xtype:'segmentedbutton',
                       items:[
                           {text:'Dishes',pressed:true, handler:tapHandler},
                           {text:'Restaurants', handler:tapHandler}
                       ]}
                   ]
               }/*,
               {
                   id:'bottomPanel',
                   xtype: 'toolbar',
                   dock:'bottom',
                   ui:'dark',
                   items:[
                       {xtype:'segmentedbutton',
                       items:[
                           {text:'Nearby',pressed:true}
                       ]}
                    ]
               }
                       */
           ]
       });

           var restaurantPnl = new Ext.Panel({
               id: 'restaurantPnl',
               items: [restPnl,aRestaurantList],
               fullscreen:true,
               layout: {
                   type: 'vbox',
                   align: 'start',
                   direction: 'normal'
               },
               dockedItems:[
                   {
                       dock:'top',
                       xtype:'toolbar',
                       ui:'light',
                       title:'Crave',
                       items:[{text:'Back',ui:'back', handler:backHandler}]
                   }
               ]
           });

           var mainPnl = new Ext.Panel({
               fullscreen: true,
               id: 'mainPnl',
               items: [listPnl,detailPnl,restaurantPnl],
               layout: {
                   type: 'card'
               },
               cardSwitchAnimation: 'slide',
               direction:'horizontal'
           });

   }

});
</script>

</body>
</html>